# 텔레그램 알림 시스템 설정 가이드

현대W&P 견적 시스템에 텔레그램 알림 기능이 추가되었습니다. 새로운 견적이 접수되면 자동으로 텔레그램 그룹으로 알림이 전송됩니다.

## 1. 텔레그램 봇 생성

### 1-1. BotFather를 통한 봇 생성
1. 텔레그램에서 `@BotFather` 검색 후 대화 시작
2. `/newbot` 명령어 입력
3. 봇 이름 입력 (예: Hyundai WNP Bot)
4. 봇 사용자명 입력 (예: hyundai_wnp_bot)
5. 봇 토큰 복사 (예: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

### 1-2. 그룹에 봇 추가
1. 텔레그램 그룹 생성 또는 기존 그룹 선택
2. 그룹에 생성한 봇 추가
3. 봇을 관리자로 설정 (권장)

## 2. Chat ID 확인

### 2-1. 그룹 Chat ID 확인 방법
1. 그룹에 `@userinfobot` 추가
2. `@userinfobot`에게 메시지 전송
3. Chat ID 확인 (예: `-1001234567890`)

### 2-2. 개인 Chat ID 확인 방법
1. `@userinfobot`과 개인 대화 시작
2. 아무 메시지나 전송
3. Chat ID 확인 (예: `123456789`)

## 3. 환경 변수 설정

`.env` 파일에 다음 변수들을 추가하세요:

```env
# 텔레그램 봇 설정
TG_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TG_CHAT_ID=-1001234567890
```

## 4. 시스템 특징

### 4-1. 트랜잭셔널 Outbox 패턴
- 견적 저장과 텔레그램 알림이 하나의 트랜잭션으로 처리
- DB 저장이 성공해야만 알림이 큐에 추가됨
- 알림 전송 실패 시 자동 재시도 (최대 5회)

### 4-2. 자동 재시도 시스템
- **대기 시간**: 1분 → 5분 → 15분 → 1시간 → 3시간 → 6시간 → 12시간
- **최대 재시도**: 5회
- **워커 실행**: 5초마다
- **실패 알림 재처리**: 1시간마다

### 4-3. 알림 메시지 형식
```
🧺 새 견적 도착

• 업체명: ○○헬스장
• 담당자: 홍길동
• 연락처: 010-1234-5678
• 이메일: test@example.com
• 서비스: 헬스장
• 세탁물: 운동복
• 빈도: 매일
• 수량: 50개
• 위치: 서울시 강남구
• 특이사항: -
• 메모: -
• 접수시간: 2024. 1. 15. 오후 2:30:45
```

## 5. 관리자 기능

### 5-1. 알림 상태 모니터링
- 관리자 페이지(`/admin`)에서 알림 상태 통계 확인
- 대기중/처리중/전송완료/실패 건수 실시간 표시

### 5-2. 수동 재시도
- API 엔드포인트: `POST /admin/notifications/retry`
- 실패한 알림들을 즉시 재처리

## 6. 트러블슈팅

### 6-1. 알림이 전송되지 않는 경우
1. `.env` 파일의 `TG_TOKEN`, `TG_CHAT_ID` 확인
2. 봇이 그룹에 추가되어 있는지 확인
3. 봇에게 메시지 전송 권한이 있는지 확인
4. 서버 로그에서 에러 메시지 확인

### 6-2. 자주 발생하는 에러
- `403 Forbidden`: 봇이 그룹에서 제거되었거나 권한 없음
- `400 Bad Request`: 잘못된 Chat ID 또는 메시지 형식
- `429 Too Many Requests`: 텔레그램 API 제한 초과

### 6-3. 로그 확인
```bash
# 서버 로그에서 텔레그램 관련 로그 확인
npm run logs
```

## 7. 보안 고려사항

- `.env` 파일은 절대 Git에 커밋하지 마세요
- 텔레그램 봇 토큰을 외부에 노출하지 마세요
- 그룹 Chat ID를 공개하지 마세요

## 8. 성능 최적화

- 트래픽이 많은 경우 워커를 별도 프로세스로 분리 고려
- PM2, systemd, 또는 cron을 통한 워커 프로세스 관리
- 데이터베이스 인덱스 최적화 (이미 적용됨)

## 9. 모니터링

시스템 상태를 확인하려면:
```bash
# 서버 상태 확인
npm run status

# 실시간 로그 확인
npm run logs
```

관리자 페이지에서 알림 통계를 실시간으로 모니터링할 수 있습니다.
